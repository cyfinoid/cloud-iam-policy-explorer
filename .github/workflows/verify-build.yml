name: Verify Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Minimal permissions required for this workflow
permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking for required application files..."
          
          required_files=(
            "index.html"
            "styles.css"
            "aws-handler.js"
            "policy-visualizer.js"
            "policy-expansion.js"
            "app.js"
            "README.md"
          )
          
          missing_files=()
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ $file exists"
            else
              echo "✗ $file is missing"
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -ne 0 ]; then
            echo ""
            echo "❌ Missing required files:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          fi
          
          echo ""
          echo "✅ All required files present!"

      - name: Check HTML syntax
        run: |
          echo "Checking HTML syntax..."
          if grep -q "<!DOCTYPE html>" index.html; then
            echo "✓ HTML DOCTYPE found"
          else
            echo "✗ HTML DOCTYPE missing"
            exit 1
          fi
          
          if grep -q "</html>" index.html; then
            echo "✓ HTML closing tag found"
          else
            echo "✗ HTML closing tag missing"
            exit 1
          fi
          
          echo "✅ HTML syntax check passed!"

      - name: Check JavaScript structure
        run: |
          echo "Checking JavaScript structure..."
          
          # Check for AWS SDK loading via importmap
          if grep -q 'type="importmap"' index.html; then
            echo "✓ Import map detected for AWS SDK"
          else
            echo "⚠ No import map found"
          fi
          
          # Check for AWS SDK global exposure
          if grep -q 'window.IAMClient' index.html || grep -q 'window.awsSdkLoaded' index.html; then
            echo "✓ AWS SDK globals setup found"
          else
            echo "⚠ AWS SDK global setup not found"
          fi
          
          # Check for main classes
          if grep -q 'class AWSHandler' aws-handler.js; then
            echo "✓ AWSHandler class found"
          fi
          
          if grep -q 'class PolicyVisualizer' policy-visualizer.js; then
            echo "✓ PolicyVisualizer class found"
          fi
          
          if grep -q 'class PolicyExpansion' policy-expansion.js; then
            echo "✓ PolicyExpansion class found"
          fi
          
          if grep -q 'class App' app.js; then
            echo "✓ App class found"
          fi
          
          echo "✅ JavaScript structure check complete!"

      - name: Check cache-busting versions
        run: |
          echo "Checking cache-busting version parameters..."
          
          if grep -q '\.css?v=' index.html; then
            echo "✓ CSS has version parameter"
          else
            echo "⚠ CSS missing version parameter"
          fi
          
          if grep -q '\.js?v=' index.html; then
            echo "✓ JS files have version parameters"
          else
            echo "⚠ JS files missing version parameters"
          fi
          
          echo "✅ Cache-busting check complete!"

      - name: Summary
        run: |
          echo ""
          echo "╔══════════════════════════════════════════════════════╗"
          echo "║                                                      ║"
          echo "║           ✅ Build Verification Passed               ║"
          echo "║                                                      ║"
          echo "╚══════════════════════════════════════════════════════╝"
          echo ""
          echo "All checks completed successfully!"
          echo "Ready for deployment to GitHub Pages."

